---
title: "PASH Analysis"
author: "Seraphina Shi"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include = FALSE}
setwd("/Users/seraphinashi/Desktop/Projects/PAHS/Xuanwei Study coal and DNA metylation study/Seraphina's folder/PAHS-scripts")

plotFolder <- "../images/03_analysis/"
if(!file.exists(plotFolder)) dir.create(plotFolder,recursive=TRUE)

knitr::opts_chunk$set(
  cache=FALSE, autodep=FALSE, warning=FALSE, message=FALSE, echo=FALSE,
  results = 'markup', dev='png', dpi=150, fig.align = "center", fig.path=plotFolder,
  cache.path=".cache/",
  duplicate.label="allow"
)

```

```{r}
source('shared_commands.R')
```

```{r}
df <- read.csv("../data/data_cleaned.csv") %>% select(-X)
```


```{r define_functions_1}
library(lmtest)
preform_lmtest_mix <- function(Y, X, log_trans_X = F, dat = df) {
  tmp <- dat
  for(i in 1:length(X)){
    X_i <- X[i]
    tmp <- tmp[!is.na(tmp[,X_i]),]
    if(log_trans_X) {
      tmp[,X_i] <- log(tmp[,X_i])
    }
  }
  
  X_form <- paste(X, collapse  = " + ")
  
  form_full <- as.formula(paste0(Y," ~ ", X_form, " + ", paste(var_name_list$confounders[-1], collapse  = " + ")))
  lmfit_full <- lm(form_full, data = tmp)
  form_reduced <- as.formula(paste0(Y," ~ ", paste(var_name_list$confounders[-1], collapse  = " + ")))
  lmfit_reduced <- lm(form_reduced, data = tmp)
  
  lrtest <- lrtest(lmfit_full, lmfit_reduced)

  return(round(lrtest$`Pr(>Chisq)`, 4)[2])
}

preform_lmtest_simple <- function(Y, X, dat = df, log_trans_X = F) {
  tmp <- dat
  for(i in 1:length(X)){
    X_i <- X[i]
    tmp <- tmp[!is.na(tmp[,X_i]),]
    if(log_trans_X) {
      tmp[,X_i] <- log(tmp[,X_i])
    }
  }
  
  X_form <- paste(X, collapse  = " + ")
  
  form_full <- as.formula(paste0(Y," ~ ", X_form))
  lmfit_full <- lm(form_full, data = tmp)
  form_reduced <- as.formula(paste0(Y," ~ 1"))
  lmfit_reduced <- lm(form_reduced, data = tmp)
  
  lrtest <- lrtest(lmfit_full, lmfit_reduced)

  return(round(lrtest$`Pr(>Chisq)`, 4)[2])
}


preform_regression <- function(Y, X, log_trans_X = F, adjust_cfd = F, dat = df) {
  tmp <- dat[!is.na(dat[,X]),]
  if(log_trans_X) {
    tmp[,X] <- log(tmp[,X])
  }
  
  form <- ifelse(adjust_cfd, 
                 paste0(Y," ~ ", X, " + ", paste(var_name_list$confounders[-1], collapse  = " + ")),
                 paste0(Y,"~",X))
  form <- as.formula(form)
  lmfit <- lm(form, data = tmp)
  coef <- summary(lmfit)$coefficients[2,1]
  coef_text <- as.character(round(coef,4))
  std <- summary(lmfit)$coefficients[2,2]
  std_text <- as.character(round(std,4))
  p_val <- summary(lmfit)$coefficients[2,4]
  sig_star <- ifelse(p_val<0.001, "***",
                ifelse(p_val<0.01, "** ",
                       ifelse(p_val<0.05, "*  ", "   ")))
  sig_level <- ifelse(p_val <= 0.001, "<= 0.001",
                ifelse(p_val <= 0.01, "<= 0.01",
                       ifelse(p_val <= 0.05, "<= 0.05", "> 0.05")))
  rlt <- paste0(coef_text, paste0(rep(" ", 7-nchar(coef_text)), collapse = ""),
                sig_star,
                "(", std_text, paste0(rep(" ", 6-nchar(std_text)), collapse = ""), ")")
  ci_l <- coef - 1.96 * std
  ci_u <- coef + 1.96 * std
  return(c(rlt, coef, ci_l, ci_u, p_val, sig_level))
}


preform_regression_exposure_prototype <- function(X, Y, log_trans_X=F) {
  
  tmp <- df
  for(i in 1:length(X)){
    X_i <- X[i]
    tmp <- tmp[!is.na(tmp[,X_i]),]
    if(log_trans_X) {
      tmp[,X_i] <- log(tmp[,X_i])
    }
  }
  
  X_form <- paste(X, collapse  = " + ")
  
  tmp <- tmp[tmp$Group == "LEX", ]

  form <- as.formula(paste0(Y," ~ ", X_form, " + ", paste(var_name_list$confounders[-1], collapse  = " + "), " + curStove"))
  lmfit <- lm(form, data = tmp)

  coefs <- as.data.frame(summary(lmfit)$coefficients)
  colnames(coefs) <- c("coefficient", "std", "t_val", "pval")
  coefs$pval_BHadj <- p.adjust(coefs$pval, method = "BH")

  coefs <- coefs %>%
    select(coefficient, std, pval, pval_BHadj) %>%
    mutate(ci_lower = coefficient - 1.96 * std,
           ci_upper = coefficient + 1.96 * std,
           sig_level = ifelse(pval <= 0.001, "<= 0.001",
                        ifelse(pval <= 0.01, "<= 0.01",
                               ifelse(pval <= 0.05, "<= 0.05", "> 0.05")))) %>% 
    select(coefficient, std, ci_lower, ci_upper, pval, sig_level, pval_BHadj)
  
  return(coefs)
}


sig_color <- c("<= 0.001" = "#7CAE00", "<= 0.01" = "#00BFC4", "<= 0.05" = "#C77CFF", "> 0.05" = "black")

make_forest_plot <- function(df_plot, exposure){
  df_plot$sig_level <- as.factor(df_plot$sig_level)
  p <- ggplot(data=df_plot, aes(x=EAAs, y=coefficient, ymin=ci_lower, ymax=ci_upper)) +
    geom_point(shape=24, size=2, aes(col = sig_level, fill = sig_level)) +
    geom_errorbar(shape=24, width=0.3, aes(col = sig_level)) +
    geom_hline(yintercept=0, lty=2,color="red") +  # add a dotted line at x=1 after flip
    # ylim(c(-2,2)) +  # not working
    coord_flip() +  # flip coordinates (puts labels on y axis)
    labs(x=expression(log[2]-PFAS))+
    labs(y="Change in year") +
    ggtitle(exposure)+
    theme(plot.title = element_text(size=8.6, hjust = 0.5),
          axis.title.y = element_blank(),
          panel.grid.major.x = element_blank(),
          axis.text.y = element_text(size=8),
          axis.title.x = element_text(size=8),
          axis.text = element_text(size=7)) +
    scale_color_manual(values = sig_color) +
    scale_fill_manual(values = sig_color)

  return(p)
}

make_forest_plot_lg <- function(df, exposure){
  df$sig_level <- as.factor(df$sig_level)
  p <- ggplot(data=df, aes(x=EAAs, y=coefficient, ymin=ci_lower, ymax=ci_upper)) +
    geom_point(shape=24, size=2, aes(col = sig_level, fill = sig_level)) +
    geom_errorbar(shape=24, width=0.3, aes(col = sig_level)) +
    geom_hline(yintercept=0, lty=2,color="red") +  # add a dotted line at x=1 after flip
    # ylim(c(-2,2)) +  # not working
    coord_flip() +  # flip coordinates (puts labels on y axis)
    labs(x=expression(log[2]-PFAS))+
    labs(y="Change in year") +
    ggtitle(exposure)+
    theme(plot.title = element_text(size=15, hjust = 0.5),
          axis.title.y = element_blank(),
          panel.grid.major.x = element_blank(),
          axis.text.y = element_text(size=10),
          axis.title.x = element_text(size=10),
          axis.text = element_text(size=10)) +
    scale_color_manual(values = sig_color) +
    scale_fill_manual(values = sig_color)

  return(p)
}


options(scipen = 999)
```

```{r define_functions_2}
library(geepack)

preform_gee <- function(Y, X, log_trans_X = F, adjust_cfd = F, dat = df) {
  tmp <- dat[!is.na(dat[,X]),]
  tmp$curStove[is.na(tmp$curStove)] <- "NA"
  if(log_trans_X) {
    tmp[,X] <- log(tmp[,X])
  }
  
  form <- ifelse(adjust_cfd, 
                 paste0(Y," ~ ", X, " + ", paste(var_name_list$confounders[-1], collapse  = " + ")),
                 paste0(Y,"~",X))
  form <- as.formula(form)
  geefit <- geeglm(formula = form, 
                data = tmp,
                id = SbjctD,
                family = gaussian,
                corstr = "exchangeable") # This says all pairs of responses within a subject are equally correlated
  coef <- summary(geefit)$coefficients[2,1]
  coef_text <- as.character(round(coef,4))
  std <- summary(geefit)$coefficients[2,2]
  std_text <- as.character(round(std,4))
  p_val <- summary(geefit)$coefficients[2,4]
  sig_star <- ifelse(p_val<0.001, "***",
                ifelse(p_val<0.01, "** ",
                       ifelse(p_val<0.05, "*  ", "   ")))
  sig_level <- ifelse(p_val <= 0.001, "<= 0.001",
                ifelse(p_val <= 0.01, "<= 0.01",
                       ifelse(p_val <= 0.05, "<= 0.05", "> 0.05")))
  rlt <- paste0(coef_text, paste0(rep(" ", 7-nchar(coef_text)), collapse = ""),
                sig_star,
                "(", std_text, paste0(rep(" ", 6-nchar(std_text)), collapse = ""), ")")
  ci_l <- coef - 1.96 * std
  ci_u <- coef + 1.96 * std
  return(c(rlt, coef, ci_l, ci_u, p_val, sig_level))
}

```

# 1. Description of study population

# 2. Self-reported categorical fuel type

# 3. Cluster-based analyses
## PAH31 (no confounders)
```{r}
  lm_coef_ambient <- c()
  plot_df <- data.frame(matrix(NA, ncol = 6))
  for(i in 1:length(var_name_list$EEAs)){
    rlts = preform_gee(Y = var_name_list$EEAs[i], 
                              X = "CUR6_PAH31", 
                              adjust_cfd = T, 
                              dat=df)
    lm_coef_ambient[i] <- rlts[1]
    plot_df[i,] <- rlts
  }
  colnames(plot_df) <- c("coef (sd)", "coefficient", "ci_lower", "ci_upper", "p_val", "sig_level")
  rownames(plot_df) <- var_name_list$EEAs
  plot_df$EAAs <- EAAs_names
  plot_df$EAAs <- factor(EAAs_names, levels=rev(c(EAAs_names[EAAs_names != "DNAmTL"], "DNAmTL")))

  plot_df$coefficient = as.numeric(plot_df$coefficient)
  plot_df$ci_lower = as.numeric(plot_df$ci_lower)
  plot_df$ci_upper = as.numeric(plot_df$ci_upper)

  lm_coef_ambient_plot <- make_forest_plot(plot_df, "CUR6_PAH31")

# lm_coef_ambient[9,1] <- c("[P<0.001: ***; P<0.01: **; P<0.05: *]")
# colnames(lm_coef_ambient) <- "PCH_5MC"
# rownames(lm_coef_ambient) <- c(EAAs_names, "")
print(" Result data: ")
print(plot_df)
lm_coef_ambient_plot
```
## PAH31 (MIX)
```{r}
  lm_coef_ambient <- c()
  plot_df <- data.frame(matrix(NA, ncol = 6))
  for(i in 1:length(var_name_list$EEAs)){
    rlts = preform_gee(Y = var_name_list$EEAs[i], 
                              X = "CUR6_PAH31", 
                              adjust_cfd = T, 
                              dat=df)
    lm_coef_ambient[i] <- rlts[1]
    plot_df[i,] <- rlts
  }
  colnames(plot_df) <- c("coef (sd)", "coefficient", "ci_lower", "ci_upper", "p_val", "sig_level")
  rownames(plot_df) <- var_name_list$EEAs
  plot_df$EAAs <- EAAs_names
  plot_df$EAAs <- factor(EAAs_names, levels=rev(c(EAAs_names[EAAs_names != "DNAmTL"], "DNAmTL")))

  plot_df$coefficient = as.numeric(plot_df$coefficient)
  plot_df$ci_lower = as.numeric(plot_df$ci_lower)
  plot_df$ci_upper = as.numeric(plot_df$ci_upper)

  lm_coef_ambient_plot <- make_forest_plot(plot_df, "CUR6_PAH31")

# lm_coef_ambient[9,1] <- c("[P<0.001: ***; P<0.01: **; P<0.05: *]")
# colnames(lm_coef_ambient) <- "PCH_5MC"
# rownames(lm_coef_ambient) <- c(EAAs_names, "")
print(" Result data: ")
print(plot_df)
lm_coef_ambient_plot
```

# 4. 5 methylchrysene (5MC) 
```{r get_5MC_data}
df$SbjctD[is.na(df$SbjctD)] <- substr(df$SID[is.na(df$SbjctD)], 5, 7)
df$Visit[is.na(df$Visit)] <- substr(df$SID[is.na(df$Visit)], 4, 4)

library(readxl)
LEX_5MC_all <- read_excel("../data/new_exposure_files/LEX_5MC_all.xlsx")
# View(LEX_5MC_all)
LEX_5MC_all <- LEX_5MC_all %>% rename("SbjctD" = "subject_id", 
                                      "Visit" = "visit",
                                      "cur_5mc" = "sum.X5.methylchrysene_conc_final.imputed", 
                                      "cum_5mc" = "cumlife_5mc",
                                      "bir_5mc" = "birthyr_5mc",
                                      "cur_5mc_measured" = "_5_methylchrysene_conc_measured")


df <- merge(df, LEX_5MC_all, by = c("SbjctD", "Visit"), all.x=T)

var_name_list$PCH_5MC <- c("cur_5mc", "cum_5mc", "bir_5mc", "cur_5mc_measured")

dup_sbjctD <- df$SbjctD[duplicated(df$SbjctD)]
df_subs <- list("df_sub1" = df[(df$SbjctD %in% dup_sbjctD & df$Visit == 1) | (! df$SbjctD %in% dup_sbjctD),],
                "df_sub2" = df[(df$SbjctD %in% dup_sbjctD & df$Visit == 2) | (! df$SbjctD %in% dup_sbjctD),])

# View(df %>% select(var_name_list$ID, var_name_list$EEAs, var_name_list$PCH_5MC))
```

## Summary the exposure estimates:
```{r}
df %>% 
  select(var_name_list$PCH_5MC, curFuel) %>% 
  tbl_summary(by = curFuel,
              # type = all_continuous() ~ "continuous2",
              statistic=list(all_continuous() ~ "{median} ({p25}, {p75})"),
              digits = list(  ~ c(2, 1, 1)),
              missing_text = "(Missing)") %>% 
  add_overall()
```

```{r}
print("Pearson pair-wise correlation:")
cor(df %>%  select(var_name_list$PCH_5MC) %>% na.omit(), 
    method = "pearson")
```
```{r}
print("Spearman pair-wise correlation:")
cor(df %>%  select(var_name_list$PCH_5MC) %>% na.omit(), 
    method = "spearman")
```


## Primary analyses
Effect of modeled current exposure to 5MC and EAA

### Generalized estimating equations (GEE) 
#### No confounders
In the following section, we performed generalized estimating equations (GEE) with equation 
$$
\begin{aligned}
  Y = & \beta_0 + \beta_1 *cur\_5mc + \epsilon
\end{aligned}
$$
where $Y$ is one of the epigenetic age accelerations.

The estimations of $\beta_1$ with given $Y$ and current $5MC$ are shown below, which can be interpreted as "the mean of Y changes given a one-unit increase in current 5MC while holding other variables constant".
```{r gee_coef_cur_5MC_simple, fig.width=4, fig.height=3, warning=FALSE, message=FALSE}
  
  lm_coef_ambient <- c()
  plot_df <- data.frame(matrix(NA, ncol = 6))
  for(i in 1:length(var_name_list$EEAs)){
    rlts = preform_gee(Y = var_name_list$EEAs[i], 
                              X = "cur_5mc", 
                              adjust_cfd = F, 
                              dat=df)
    lm_coef_ambient[i] <- rlts[1]
    plot_df[i,] <- rlts
  }
  colnames(plot_df) <- c("coef (sd)", "coefficient", "ci_lower", "ci_upper", "p_val", "sig_level")
  rownames(plot_df) <- var_name_list$EEAs
  plot_df$EAAs <- EAAs_names
  plot_df$EAAs <- factor(EAAs_names, levels=rev(c(EAAs_names[EAAs_names != "DNAmTL"], "DNAmTL")))

  plot_df$coefficient = as.numeric(plot_df$coefficient)
  plot_df$ci_lower = as.numeric(plot_df$ci_lower)
  plot_df$ci_upper = as.numeric(plot_df$ci_upper)

  lm_coef_ambient_plot <- make_forest_plot(plot_df, "Current exposure to 5MC")

# lm_coef_ambient[9,1] <- c("[P<0.001: ***; P<0.01: **; P<0.05: *]")
# colnames(lm_coef_ambient) <- "PCH_5MC"
# rownames(lm_coef_ambient) <- c(EAAs_names, "")
print(" Result data: ")
print(plot_df)
lm_coef_ambient_plot
```


#### Mixed model
In the following section, we performed generalized estimating equations (GEE) with equation 
$$
\begin{aligned}
  Y = & \beta_0 + \beta_1 *cur\_5mc\\
  & + \beta_2 * county + \beta_3 * BMI + \beta_4 * ses + \beta_5 * edu  + \epsilon
\end{aligned}
$$
where $Y$ is one of the epigenetic age accelerations.

The estimations of $\beta_1$ with given $Y$ and current $5MC$ are shown below, which can be interpreted as "the mean of Y changes given a one-unit increase in current 5MC while holding other variables constant".
```{r gee_coef_cur_5MC, fig.width=4, fig.height=3, warning=FALSE, message=FALSE}
  
  lm_coef_ambient <- c()
  plot_df <- data.frame(matrix(NA, ncol = 6))
  for(i in 1:length(var_name_list$EEAs)){
    rlts = preform_gee(Y = var_name_list$EEAs[i], 
                              X = "cur_5mc", 
                              adjust_cfd = T, 
                              dat=df)
    lm_coef_ambient[i] <- rlts[1]
    plot_df[i,] <- rlts
  }
  colnames(plot_df) <- c("coef (sd)", "coefficient", "ci_lower", "ci_upper", "p_val", "sig_level")
  rownames(plot_df) <- var_name_list$EEAs
  plot_df$EAAs <- EAAs_names
  plot_df$EAAs <- factor(EAAs_names, levels=rev(c(EAAs_names[EAAs_names != "DNAmTL"], "DNAmTL")))

  plot_df$coefficient = as.numeric(plot_df$coefficient)
  plot_df$ci_lower = as.numeric(plot_df$ci_lower)
  plot_df$ci_upper = as.numeric(plot_df$ci_upper)

  lm_coef_ambient_plot <- make_forest_plot(plot_df, "Current exposure to 5MC")

# lm_coef_ambient[9,1] <- c("[P<0.001: ***; P<0.01: **; P<0.05: *]")
# colnames(lm_coef_ambient) <- "PCH_5MC"
# rownames(lm_coef_ambient) <- c(EAAs_names, "")
print(" Result data: ")
print(plot_df)
lm_coef_ambient_plot
```



### Linear Regression (mix model)
In the following section, we performed linear regression with equation 
$$
\begin{aligned}
  Y = & \beta_0 + \beta_1 *cur\_5mc\\
  & + \beta_2 * county + \beta_3 * BMI + \beta_4 * ses + \beta_5 * edu  + \epsilon
\end{aligned}
$$
where $Y$ is one of the epigenetic age accelerations.

The estimations of $\beta_1$ with given $Y$ and $5MC$ are shown below, which can be interpreted as "the mean of Y changes given a one-unit increase in current 5MC while holding other variables constant".

#### Including all visits
```{r linear_coef_cur_5MC, fig.width=4, fig.height=3}
  plot_df <- data.frame(matrix(NA, ncol = 6))
  for(i in 1:length(var_name_list$EEAs)){
    rlts = preform_regression(Y = var_name_list$EEAs[i], 
                              X = "cur_5mc", 
                              adjust_cfd = T, 
                              dat=df)
    plot_df[i,] <- rlts
  }
  colnames(plot_df) <- c("coef (sd)", "coefficient", "ci_lower", "ci_upper", "p_val", "sig_level")
  rownames(plot_df) <- var_name_list$EEAs
  plot_df$EAAs <- EAAs_names
  plot_df$EAAs <- factor(EAAs_names, levels=rev(c(EAAs_names[EAAs_names != "DNAmTL"], "DNAmTL")))

  plot_df$coefficient = as.numeric(plot_df$coefficient)
  plot_df$ci_lower = as.numeric(plot_df$ci_lower)
  plot_df$ci_upper = as.numeric(plot_df$ci_upper)

  lm_coef_ambient_plot <- make_forest_plot(plot_df, "Current exposure to 5MC")

  print(" Result data: ")
  print(plot_df)
  lm_coef_ambient_plot
```

#### Only including one of the two visits 
```{r linear_coef_cur_5MC_subs, fig.width=3, fig.height=4}
lm_coef_ambient <- data.frame()
lm_coef_ambient_plots <- list()

for(j in 1:2){
  plot_df <- data.frame(matrix(NA, ncol = 6))
  for(i in 1:length(var_name_list$EEAs)){
    rlts = preform_regression(Y = var_name_list$EEAs[i], 
                              X = "cur_5mc", 
                              adjust_cfd = T, 
                              dat=df_subs[[j]])
    lm_coef_ambient[i,j] <- rlts[1]
    plot_df[i,] <- rlts
  }
  colnames(plot_df) <- c("coef (sd)", "coefficient", "ci_lower", "ci_upper", "p_val", "sig_level")
  rownames(plot_df) <- var_name_list$EEAs
  plot_df$EAAs <- EAAs_names
  plot_df$EAAs <- factor(EAAs_names, levels=rev(c(EAAs_names[EAAs_names != "DNAmTL"], "DNAmTL")))

  plot_df$coefficient = as.numeric(plot_df$coefficient)
  plot_df$ci_lower = as.numeric(plot_df$ci_lower)
  plot_df$ci_upper = as.numeric(plot_df$ci_upper)

  pj <- make_forest_plot(plot_df, "Current exposure to 5MC")
  lm_coef_ambient_plots[[j]] = pj
}


lm_coef_ambient[9,1] <- c("[P<0.001: ***; P<0.01: **; P<0.05: *]")
colnames(lm_coef_ambient) <- "PCH_5MC"
rownames(lm_coef_ambient) <- c(EAAs_names, "")
```

Including all of the single visits and the 1st visit for these `r length(dup_sbjctD)` subjects who have been visited twice. 
```{r linear_coef_cur_5MC_sub_1, fig.height=3, fig.width=4}
lm_coef_ambient_plots[[1]]
```

Including all of the single visits and the 2nd visit for these `r length(dup_sbjctD)` subjects who have been visited twice. 
```{r linear_coef_cur_5MC_sub_2, fig.height=3, fig.width=4}
lm_coef_ambient_plots[[2]]
```



## Secondary analyses
### i. Effect of modeled cumulative exposure to 5MC and EAA
#### Generalized estimating equations (GEE) 
In the following section, we performed generalized estimating equations (GEE) with equation 
$$
\begin{aligned}
  Y = & \beta_0 + \beta_1 *cum\_5mc\\
  & + \beta_2 * county + \beta_3 * BMI + \beta_4 * ses + \beta_5 * edu + \epsilon
\end{aligned}
$$
where $Y$ is one of the epigenetic age accelerations.

The estimations of $\beta_1$ with given $Y$ and cumulative $5MC$ are shown below, which can be interpreted as "the mean of Y changes given a one-unit increase in cumulative 5MC while holding other variables constant".
```{r gee_coef_cum_5MC, fig.width=4, fig.height=3, warning=FALSE, message=FALSE}
  
  lm_coef_ambient <- c()
  plot_df <- data.frame(matrix(NA, ncol = 6))
  for(i in 1:length(var_name_list$EEAs)){
    rlts = preform_gee(Y = var_name_list$EEAs[i], 
                              X = "cum_5mc", 
                              adjust_cfd = T, 
                              dat=df)
    lm_coef_ambient[i] <- rlts[1]
    plot_df[i,] <- rlts
  }
  colnames(plot_df) <- c("coef (sd)", "coefficient", "ci_lower", "ci_upper", "p_val", "sig_level")
  rownames(plot_df) <- var_name_list$EEAs
  plot_df$EAAs <- EAAs_names
  plot_df$EAAs <- factor(EAAs_names, levels=rev(c(EAAs_names[EAAs_names != "DNAmTL"], "DNAmTL")))

  plot_df$coefficient = as.numeric(plot_df$coefficient)
  plot_df$ci_lower = as.numeric(plot_df$ci_lower)
  plot_df$ci_upper = as.numeric(plot_df$ci_upper)

  lm_coef_ambient_plot <- make_forest_plot(plot_df, "Cumulative exposure to 5MC")

# lm_coef_ambient[9,1] <- c("[P<0.001: ***; P<0.01: **; P<0.05: *]")
# colnames(lm_coef_ambient) <- "PCH_5MC"
# rownames(lm_coef_ambient) <- c(EAAs_names, "")
print(" Result data: ")
print(plot_df)
lm_coef_ambient_plot
```


#### Linear Regression (mix model)
In the following section, we performed linear regression with equation 
$$
\begin{aligned}
  Y = & \beta_0 + \beta_1 *cum\_5mc\\
  & + \beta_2 * county + \beta_3 * BMI + \beta_4 * ses + \beta_5 * edu  + \epsilon
\end{aligned}
$$
where $Y$ is one of the epigenetic age accelerations.

The estimations of $\beta_1$ with given $Y$ and $5MC$ are shown below, which can be interpreted as "the mean of Y changes given a one-unit increase in cumulative 5MC while holding other variables constant".

##### Including all visits
```{r linear_coef_cum_5MC, fig.width=4, fig.height=3}
  plot_df <- data.frame(matrix(NA, ncol = 6))
  for(i in 1:length(var_name_list$EEAs)){
    rlts = preform_regression(Y = var_name_list$EEAs[i], 
                              X = "cum_5mc", 
                              adjust_cfd = T, 
                              dat=df)
    plot_df[i,] <- rlts
  }
  colnames(plot_df) <- c("coef (sd)", "coefficient", "ci_lower", "ci_upper", "p_val", "sig_level")
  rownames(plot_df) <- var_name_list$EEAs
  plot_df$EAAs <- EAAs_names
  plot_df$EAAs <- factor(EAAs_names, levels=rev(c(EAAs_names[EAAs_names != "DNAmTL"], "DNAmTL")))

  plot_df$coefficient = as.numeric(plot_df$coefficient)
  plot_df$ci_lower = as.numeric(plot_df$ci_lower)
  plot_df$ci_upper = as.numeric(plot_df$ci_upper)

  lm_coef_ambient_plot <- make_forest_plot(plot_df, "Cumulative exposure to 5MC")

  print(" Result data: ")
  print(plot_df)
  lm_coef_ambient_plot
```


### ii. Effect of modeled birth home/childhood exposure to 5MC
#### Generalized estimating equations (GEE) 
In the following section, we performed generalized estimating equations (GEE) with equation 
$$
\begin{aligned}
  Y = & \beta_0 + \beta_1 *birth\_5mc\\
  & + \beta_2 * county + \beta_3 * BMI + \beta_4 * ses + \beta_5 * edu  + \epsilon
\end{aligned}
$$
where $Y$ is one of the epigenetic age accelerations.

The estimations of $\beta_1$ with given $Y$ and birth home/childhood  $5MC$ are shown below, which can be interpreted as "the mean of Y changes given a one-unit increase in birth home/childhood 5MC while holding other variables constant".
```{r gee_coef_birth_5MC, fig.width=4, fig.height=3, warning=FALSE, message=FALSE}
  lm_coef_ambient <- c()
  plot_df <- data.frame(matrix(NA, ncol = 6))
  for(i in 1:length(var_name_list$EEAs)){
    rlts = preform_gee(Y = var_name_list$EEAs[i], 
                              X = "bir_5mc", 
                              adjust_cfd = T, 
                              dat=df)
    lm_coef_ambient[i] <- rlts[1]
    plot_df[i,] <- rlts
  }
  colnames(plot_df) <- c("coef (sd)", "coefficient", "ci_lower", "ci_upper", "p_val", "sig_level")
  rownames(plot_df) <- var_name_list$EEAs
  plot_df$EAAs <- EAAs_names
  plot_df$EAAs <- factor(EAAs_names, levels=rev(c(EAAs_names[EAAs_names != "DNAmTL"], "DNAmTL")))

  plot_df$coefficient = as.numeric(plot_df$coefficient)
  plot_df$ci_lower = as.numeric(plot_df$ci_lower)
  plot_df$ci_upper = as.numeric(plot_df$ci_upper)

  lm_coef_ambient_plot <- make_forest_plot(plot_df, "Birth home/childhood exposure to 5MC")

# lm_coef_ambient[9,1] <- c("[P<0.001: ***; P<0.01: **; P<0.05: *]")
# colnames(lm_coef_ambient) <- "PCH_5MC"
# rownames(lm_coef_ambient) <- c(EAAs_names, "")
print(" Result data: ")
print(plot_df)
lm_coef_ambient_plot
```



#### Linear Regression (mix model)
In the following section, we performed linear regression with equation 
$$
\begin{aligned}
  Y = & \beta_0 + \beta_1 *birth\_5mc\\
  & + \beta_2 * county + \beta_3 * BMI + \beta_4 * ses + \beta_5 * edu  + \epsilon
\end{aligned}
$$
where $Y$ is one of the epigenetic age accelerations.

The estimations of $\beta_1$ with given $Y$ and birth home/childhood $5MC$ are shown below, which can be interpreted as "the mean of Y changes given a one-unit increase in birth home/childhood 5MC while holding other variables constant".

##### Including all visits
```{r linear_coef_birth_5MC, fig.width=4, fig.height=3}
  plot_df <- data.frame(matrix(NA, ncol = 6))
  for(i in 1:length(var_name_list$EEAs)){
    rlts = preform_regression(Y = var_name_list$EEAs[i], 
                              X = "bir_5mc", 
                              adjust_cfd = T, 
                              dat=df)
    plot_df[i,] <- rlts
  }
  colnames(plot_df) <- c("coef (sd)", "coefficient", "ci_lower", "ci_upper", "p_val", "sig_level")
  rownames(plot_df) <- var_name_list$EEAs
  plot_df$EAAs <- EAAs_names
  plot_df$EAAs <- factor(EAAs_names, levels=rev(c(EAAs_names[EAAs_names != "DNAmTL"], "DNAmTL")))

  plot_df$coefficient = as.numeric(plot_df$coefficient)
  plot_df$ci_lower = as.numeric(plot_df$ci_lower)
  plot_df$ci_upper = as.numeric(plot_df$ci_upper)

  lm_coef_ambient_plot <- make_forest_plot(plot_df, "Birth home/childhood exposure to 5MC")

  print(" Result data: ")
  print(plot_df)
  lm_coef_ambient_plot
```


### iii.	Effect of measured current exposure to 5MC
#### Generalized estimating equations (GEE) 
In the following section, we performed generalized estimating equations (GEE) with equation 
$$
\begin{aligned}
  Y = & \beta_0 + \beta_1 *cur\_measured\_5mc\\
  & + \beta_2 * county + \beta_3 * BMI + \beta_4 * ses + \beta_5 * edu  + \epsilon
\end{aligned}
$$
where $Y$ is one of the epigenetic age accelerations.

The estimations of $\beta_1$ with given $Y$ and measured current exposure to  $5MC$ are shown below, which can be interpreted as "the mean of Y changes given a one-unit increase in measured current exposure to 5MC while holding other variables constant".
```{r gee_coef_cum_measured_5MC, fig.width=4, fig.height=3, warning=FALSE, message=FALSE}
  
  lm_coef_ambient <- c()
  plot_df <- data.frame(matrix(NA, ncol = 6))
  for(i in 1:length(var_name_list$EEAs)){
    rlts = preform_gee(Y = var_name_list$EEAs[i], 
                              X = "cur_5mc_measured", 
                              adjust_cfd = T, 
                              dat=df)
    lm_coef_ambient[i] <- rlts[1]
    plot_df[i,] <- rlts
  }
  colnames(plot_df) <- c("coef (sd)", "coefficient", "ci_lower", "ci_upper", "p_val", "sig_level")
  rownames(plot_df) <- var_name_list$EEAs
  plot_df$EAAs <- EAAs_names
  plot_df$EAAs <- factor(EAAs_names, levels=rev(c(EAAs_names[EAAs_names != "DNAmTL"], "DNAmTL")))

  plot_df$coefficient = as.numeric(plot_df$coefficient)
  plot_df$ci_lower = as.numeric(plot_df$ci_lower)
  plot_df$ci_upper = as.numeric(plot_df$ci_upper)

  lm_coef_ambient_plot <- make_forest_plot(plot_df, "Measured current exposure to 5MC")

# lm_coef_ambient[9,1] <- c("[P<0.001: ***; P<0.01: **; P<0.05: *]")
# colnames(lm_coef_ambient) <- "PCH_5MC"
# rownames(lm_coef_ambient) <- c(EAAs_names, "")
print(" Result data: ")
print(plot_df)
lm_coef_ambient_plot
```



#### Linear Regression (mix model)
In the following section, we performed linear regression with equation 
$$
\begin{aligned}
  Y = & \beta_0 + \beta_1 *cum\_5mc\\
  & + \beta_2 * county + \beta_3 * BMI + \beta_4 * ses + \beta_5 * edu  + \epsilon
\end{aligned}
$$
where $Y$ is one of the epigenetic age accelerations.

The estimations of $\beta_1$ with given $Y$ and measured current exposure to 5MC$ are shown below, which can be interpreted as "the mean of Y changes given a one-unit increase in measured current exposure to  5MC while holding other variables constant".

##### Including all visits
```{r linear_coef_cur_measured_5MC, fig.width=4, fig.height=3}
  plot_df <- data.frame(matrix(NA, ncol = 6))
  for(i in 1:length(var_name_list$EEAs)){
    rlts = preform_regression(Y = var_name_list$EEAs[i], 
                              X = "cur_5mc_measured", 
                              adjust_cfd = T, 
                              dat=df)
    plot_df[i,] <- rlts
  }
  colnames(plot_df) <- c("coef (sd)", "coefficient", "ci_lower", "ci_upper", "p_val", "sig_level")
  rownames(plot_df) <- var_name_list$EEAs
  plot_df$EAAs <- EAAs_names
  plot_df$EAAs <- factor(EAAs_names, levels=rev(c(EAAs_names[EAAs_names != "DNAmTL"], "DNAmTL")))

  plot_df$coefficient = as.numeric(plot_df$coefficient)
  plot_df$ci_lower = as.numeric(plot_df$ci_lower)
  plot_df$ci_upper = as.numeric(plot_df$ci_upper)

  lm_coef_ambient_plot <- make_forest_plot(plot_df, "Measured current exposure to 5MC")

  print(" Result data: ")
  print(plot_df)
  lm_coef_ambient_plot
```

# 5. Additional secondary analyses




